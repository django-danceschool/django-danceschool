{% extends "cms/admin_home.html" %}
{% load danceschool_tags sekizai_tags i18n %}

{% block content %}

{% if scope == "invoice" %}
	<h3>{% blocktrans with id=invoice.id %}Check-in for invoice #{{ id }}{% endblocktrans %}</h3>
{% else %}
	<h3>{{ event.name }}</h3>

	<dl>
		<dt>{% trans "Total Students" %}:</dt><dd>{{ event.numRegistered }}</dd>
		<dt>{% trans "Location" %}:</dt><dd>{{ event.location.name }}{% if event.room.name %} - {{ event.room.name }}{% endif %}</dd>
		<dt>{% trans "Time" %}:</dt><dd>{{ event.startTime|date:'l, h:i A' }}</dd>
		<dt>{% trans "Partner Required" %}:</dt><dd>{{ event.partnerRequired|yesno }}</dd>
	</dl>
{% endif %}

{% if 'core.checkin_customers' in perms %}
	<form id="checkin_form">

	{% if scope == "invoice" %}
		<div class="form-group">
			<label for="checkInTypeSelect">{% trans "Select Check-In Type" %}</label>
			<div class="input-group">
				<select disabled id="checkInTypeSelect" class="form-control">
					<option value="O" selected>{% trans "Check into today's/next occurrence" %}</option>
					<option value="E">{% trans "Event-level check-in" %}</option>
				</select>
				<div class="input-group-append">
					<button id="editTypeButton" class="btn btn-secondary" type="button">{% trans "Edit" %}</button>
				</div>
			</div>
		</div>
	{% else %}
		<div class="form-group">
			<label for="occurrenceSelect">{% trans "Select Event Occurrence for Check-In" %}</label>
			<div class="input-group">
				<select disabled id="occurrenceSelect" class="form-control">
					{% for occ in event.eventoccurrence_set.all %}
					<option value="{{ occ.id }}" {% if occ.id == event.nextOccurrenceForToday.id %}selected{% endif %}>{{ occ }}</option>
					{% endfor %}
					<option value="event">{% trans "Event-level check-in" %}</option>
				</select>
				<div class="input-group-append">
					<button id="editTypeButton" class="btn btn-secondary" type="button">{% trans "Edit" %}</button>
				</div>
			</div>
		</div>
	{% endif %}

	<div class="form-group">
		<label for="nameFilter">{% trans 'Filter by customer' %}</label>
		<input type="search" class="form-control" id="nameFilter" placeholder="{% trans 'Enter name/email...' %}">
	</div>


{% endif %}

<table class="classregsummary table table-striped table-fixed">
<thead>
	<tr>
		{% if 'core.checkin_customers' in perms %}
		<th>{% trans "Check In" %}</th>
		{% endif %}
		<th>{% trans "Customer" %}</th>
		{% if scope == "invoice" %}
		<th>{% trans "Event" %}</th>
		{% endif %}
		{% if extras and extras_templates_registry %}
		<th>{% trans "Additional Info" %}</th>
		{% endif %}
		<th>{% trans "Reg. Details" %}</th>
		{% if event.partnerRequired %}<th>{% trans "Partner" %}</th>{% endif %}
		<th>{% trans "Event Pricing" %}</th>
		<th>{% trans "Total Payment" %}</th>
		<th>{% trans "Links" %}</th>
	</tr>
</thead>
<tbody id="regListing">
{% for reg in registrations %}
	<tr>
		{% if 'core.checkin_customers' in perms %}
		<td>
			<input type="checkbox" class="regCheckIn personCheckIn" id="reg_id_{{ reg.id }}" name="reg_id_{{ reg.id }}" value="{{ reg.id }}"
				data-next-occurrence="{{ reg.event.nextOccurrenceForToday.id }}"
				{% if reg.dropIn %}
					data-drop-in="true"	
					data-occurrence-ids="{% for occ in reg.occurrences.all %}{{ occ.id }}{% if not forloop.last %}|{% endif %}{% endfor %}"
				{%endif %}
			/>
			<label class="personCheckInLabel" for="reg_id_{{ reg.id }}"></label>
		</td>
		{% endif %}
		<td class="customerInfo">
			{% if reg.customer %}
				{{ reg.customer.fullName }}
				<br />{{ reg.customer.email }}
			{% elif reg.registration.invoice.fullName or reg.registration.invoice.email %}
				{{ reg.registration.invoice.fullName }}
				{% if reg.registration.invoice.fullName %}<br />{% endif %}
				{{ reg.registration.invoice.email }}
			{% else %}
				{% trans "N/A" %}
			{% endif %}
		</td>

		{% if scope == "invoice" %}
		<td>{{ reg.event.name }}</td>
		{% endif %}
		{% if extras and extras_templates_registry %}
		<td>
			{% with extras|get_item:reg.id as reg_extras %}
			{% for k,t in extras_templates_registry.items %}
				{% include t.template_name %}
			{% endfor %}
			{% endwith %}
		</td>
		{% endif %}

		<td>
		<strong>{% trans "Role" %}:</strong> {% if reg.role %}{{ reg.role }}{% else %}{% trans "N/A" %}{% endif %}<br />
			{% if reg.dropIn %}
				<strong>{% trans "Drop-in" %}{% if reg.occurrences.all %}:{% endif %}</strong>
				{% for occ in reg.occurrences.all %}
					{{ occ.startTime|date:"SHORT_DATE_FORMAT" }}{% if not forloop.last %}, {%endif %}
				{% endfor %}<br />
			{% endif %}
			{% if reg.registration.payAtDoor %}<strong>{% trans "Door registration" %}</strong><br />{% endif %}
			{% if reg.registration.student %}<strong>{% trans "Student status" %}</strong>{% endif %}
		</td>

		{% if event.partnerRequired %}
		<td>
			{% if reg.data.partner %}
				{{ reg.data.partner.firstName }} {{ reg.data.partner.lastName }}
			{% else %}
				{% trans "N/A" %}
			{% endif %}
		</td>
		{% endif %}

		<td {% if reg.warningFlag %}class="warning"{% elif reg.refundFlag %}class="info"{% endif %}>
			{% if reg.discounted or reg.warningFlag %}
				<strong>{% trans "Gross" %}:</strong> {{ reg.invoiceItem.grossTotal|floatformat:2 }} <br />
				<strong>{% trans "Net" %}:</strong> {{ reg.invoiceItem.total|floatformat:2 }}
				{% if reg.refundFlag %}<br />
				<strong>{% trans "Adjustments/Refunds" %}:</strong> {{ reg.invoiceItem.adjustments|floatformat:2 }}
				{% endif %}
				{% if reg.invoiceItem.revenueMismatch or reg.invoiceItem.revenueNotYetReceived %}<br />
				<strong>{% trans "Recorded Revenue" %}:</strong> {{ reg.invoiceItem.revenueReported|floatformat:2 }}<br />
				<strong>{% trans "Received Revenue" %}:</strong> {{ reg.invoiceItem.revenueReceived|floatformat:2 }}<br />
				{% endif %}
			{% else %}
				{{ reg.invoiceItem.total|floatformat:2 }}
			{% endif %}
		</td>

		
		{% with reg.registration.invoiceDetails as details %}
		<td 
		{% if reg.warningFlag %}
			class="warning"
		{% elif reg.refundFlag %}
			class="info"
		{% endif %}>
			{% if reg.registration.warningFlag or reg.registration.refundFlag %}
				<strong>{% trans "Gross Price" %}:</strong> {{ details.grossTotal|floatformat:2 }} <br />
				<strong>{% trans "Net Price" %}:</strong>
				{% if details.grossTotal != details.total %}
					<a href="javascript://" data-toggle="popover" title="{% trans 'Gross vs. Net Price' %}" data-container="body" data-placement="top" data-content="
					{% for d in reg.registration.registrationdiscount_set.all %}
						{% if d.discountAmount > 0 %}
							{% trans 'Discount' %}: {{ d.discount.name }} = -{{ d.discountAmount }}, 
						{% endif %}					
					{% endfor %}
					{% for v in reg.registration.invoice.voucheruse_set.all %}
						{% if v.amount > 0 %}
					 		{% trans 'Voucher' %}: {{ v.voucher.voucherId }} = -{{ v.amount }}, 
						{% endif %}
					{% endfor %}">
					{{ details.total|floatformat:2 }}</a>
				{% else %}
				 	{{ details.total|floatformat:2 }}
				{% endif %}
				{% if reg.registration.refundFlag %}<br />
				<strong>{% trans "Adjustments/Refunds" %}:</strong> {{ details.adjustments|floatformat:2 }}
				{% endif %}
				{% if reg.registration.invoice.outstandingBalance != 0 %}<br />
				<strong>{% trans "Invoice Status" %}:</strong> {{ reg.registration.invoice.get_status_display }}<br />
				<strong>{% trans "Outstanding Balance" %}:</strong> {{ reg.registration.invoice.outstandingBalance|floatformat:2 }}<br />
				{% endif %}
			{% else %}
				{% if details.grossTotal != details.total %}
					<strong>{% trans "Gross Price" %}:</strong> {{ details.grossTotal|floatformat:2 }} <br />
					<strong>{% trans "Net Price" %}:</strong>
					<a href="javascript://" data-toggle="popover" title="{% trans 'Gross vs. Net Price' %}" data-container="body" data-placement="top" data-content="
					{% for d in reg.registration.registrationdiscount_set.all %}
						{% if d.discountAmount > 0 %}
							{% trans 'Discount' %}: {{ d.discount.name }} = -{{ d.discountAmount }}, 
						{% endif %}					
					{% endfor %}
					{% for v in reg.registration.invoice.voucheruse_set.all %}
						{% if v.amount > 0 %}
					 		{% trans 'Voucher' %}: {{ v.voucher.voucherId }} = -{{ v.amount }}, 
						{% endif %}
					{% endfor %}">
					{{ details.total|floatformat:2 }}</a>
				{% else %}
					{{ details.total|floatformat:2 }}
				{% endif %}
			{% endif %}
		</td>
		{% endwith %}

		<td>
		<div class="dropdown show">
			<a class="btn btn-light btn-sm dropdown-toggle" href="#" role="button" id="itemsLink_{{ reg.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				{% trans "Related Items" %}
			</a>
			<div class="dropdown-menu" aria-labelledby="itemsLink_{{ reg.id }}">
				{% if 'core.view_all_invoices' in perms and reg.registration.invoice %}
					<a class="dropdown-item" href="{% url 'viewInvoice' reg.registration.invoice.id %}">{% trans "Invoice" %}</a>
				{% endif %}
				{% if 'core.change_registration' in perms %}
					<a class="dropdown-item" href="{% url 'admin:core_registration_change' reg.registration.id %}">{% trans "Registration" %}</a>
				{% endif %}
				{% if 'core.process_refunds' in perms %}
					{% if reg.registration.invoice %}
						<a class="dropdown-item" href="{% url 'refundProcessing' reg.registration.invoice.id %}">{% trans "Refund" %}</a>
					{% endif %}
					<a class="dropdown-item" href="{% url 'registrationTransferProcessing' reg.registration.id %}">{% trans "Transfer Registration" %}</a>
				{% endif %}
				{% if 'financial.change_revenueitem' in perms and reg.invoiceItem.revenueitem %}
					<a class="dropdown-item" href="{% url 'admin:financial_revenueitem_change' reg.invoiceItem.revenueitem.id %}">{% trans "Revenue Item" %}</a>
				{% endif %}
			</div>
		</div>
		</td>
	</tr>
{% endfor %}
</tbody>
</table>

{% if scope != "invoice" and additional_names %}
<h4>{% trans "Additional Guests" %}</h4>
<table class="additionalnames table table-striped table-fixed">
	<thead>
		<tr>
			{% if 'core.checkin_customers' in perms %}
			<th>{% trans "Check In" %}</th>
			{% endif %}
			<th>{% trans "Name" %}</th>
			{% if extras and extras_templates_registry %}
			<th>{% trans "Additional Info" %}</th>
			{% endif %}
			<th>{% trans "Details" %}</th>
		</tr>
	</thead>
	<tbody id="additionalNamesListing">
	{% for person in additional_names %}
		<tr>
			{% if 'core.checkin_customers' in perms %}
			<td>
				<input type="checkbox" class="nameCheckIn personCheckIn" id="additional_name_{{ person.first|slugify }}_{{ person.last|slugify }}" name="additional_name_{{ person.first|slugify }}_{{ person.last|slugify }}" data-first-name="{{ person.first }}" data-last-name="{{ person.last }}" />
				<label class="personCheckInLabel" for="additional_name_{{ person.first|slugify }}_{{ person.last|slugify }}"></label>
			</td>
			{% endif %}
			<td class="customerInfo">
				{{ person.first }} {{ person.last }}
				{% if person.contact %}<br />{{ person.contact }}{% endif %}
			</td>
			{% if extras and extras_templates_registry %}
			<td>
				{% with additional_names_extras|get_item:person.contact as reg_extras %}
				{% for k,t in extras_templates_registry.items %}
					{% include t.template_name %}
				{% endfor %}
				{% endwith %}
			</td>
			{% endif %}
	
			<td>{{ person.guestType }}</td>
		</tr>
	{% endfor %}
	</tbody>
	</table>
{% endif %}


{% if 'core.checkin_customers' in perms %}
	</form>
	<div id="update_error" style="display:none; font-size: 1.5em; color: #a00; background-color: #ddd; padding: 0.5em; width: 95%;">{% trans "Error submitting class check-in data." %}</div>
{% endif %}

<hr />

<p>
<a class="btn btn-secondary btn-sm" href="{% url 'registration' %}">{% trans "Class Registration Page" %}</a>
<a class="btn btn-secondary btn-sm" href="{% url 'viewregistrations_selectevent' %}">{% trans "Select Another Class" %}</a>
</p>


{% addtoblock "js" %}
	<script type="text/javascript">

	var $ = django.jQuery;

	regParams = {
		scope: "{{ scope }}",
		event: "{{ event.id }}",
		invoice: "{{ invoice.id }}",
		ajaxUrl: "{% url 'ajax_checkin' %}",
	}

	function slugify(str) {
		return str
			.normalize('NFKD')
			.toLowerCase()
			.replace(/[^\w\s-]/g, '')
			.trim()
			.replace(/[-\s]+/g, '-');
	};

	function getCheckIns() {

		$('.personCheckIn').removeAttr('disabled');
		$('.personCheckIn').show();

		var this_request = {
			request: "get_all",
			checkin_type: "E",
		};

		if (regParams.scope == "invoice") {
			this_request["scope"] = "invoice";
			this_request["invoice_id"] = regParams.invoice;
			this_request["checkin_type"] = $('#checkInTypeSelect').children("option:selected").val();
		}
		else {
			this_request["scope"] = "event";
			this_request["event_id"] = regParams.event;
			var thisOccurrence = $("#occurrenceSelect").children("option:selected").val();
			if (thisOccurrence !== "event") {
				this_request["checkin_type"] = "O";
				this_request["occurrence_id"] = thisOccurrence;

				var mismatched = $('.personCheckIn[data-drop-in="true"][data-occurrence-ids!=""]').not('[data-occurrence-ids*="' + thisOccurrence + '"]');
				$(mismatched).attr('disabled', true);
				$(mismatched).hide();

			}
		}

	    $.ajax(
	    {
	        url : regParams.ajaxUrl,
	        type: "POST",
            contentType: "application/json",
            data: JSON.stringify(this_request),
			success: function(data, textStatus, jqXHR)
	        {
				if (data["status"] !== "success") {
					$('#update_error').slideDown();
				}
				else {
					$('.personCheckIn').prop('checked', false);
					$.each(data['checkins'], function() {
						var this_element;

						if (this.eventRegistration) {
							this_element = $('#reg_id_' + this.eventRegistration);
						}
						else if (this.firstName && this.lastName) {
							this_element = $('#additional_name_' + slugify(this.firstName) + '_' + slugify(this.lastName));
						}

						if (this_element) {
							this_element.prop('checked', (this.cancelled == false));
							this_element.data('existing',"true");
						}
					});
				}
			},
	        error: function(jqXHR, textStatus, errorThrown)
	        {
	        	$('#update_error').slideDown();
	        }
	    });

	}

	$(function () {
	  $('[data-toggle="popover"]').popover();
	  getCheckIns();
	});

	$('.personCheckIn').click(function(){
		$('#update_error').slideUp();
	});

	$('#occurrenceSelect').change(function() {
		$('.personCheckIn').removeData('existing');
		getCheckIns();
	});

	$('#checkInTypeSelect').change(function() {
		$('.personCheckIn').removeData('existing');
		getCheckIns();
	});

	// Use Jquery to get the cookie value of the CSRF token
	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie !== '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = django.jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) === (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}
	var csrftoken = getCookie('csrftoken');

	function csrfSafeMethod(method) {
	    // these HTTP methods do not require CSRF protection
	    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}

	// Ensure that CSRF token is passed
	$.ajaxSetup({
	    beforeSend: function(xhr, settings) {
	        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
	            xhr.setRequestHeader("X-CSRFToken", csrftoken);
	        }
	    }
	});

	// Enable modification of occurrence.
	$(document).on("click", "#editTypeButton", function() {
		$('#occurrenceSelect').attr("disabled", false);
		$('#checkInTypeSelect').attr("disabled", false);		
	});

    // Check-in customer, guest.
    $(document).on("click", ".personCheckIn", function() {

		$('.personCheckIn').attr("disabled", true);

		var this_request = {
			request: "update",
			checkin_type: "E",
			registrations: [],
			names: [],
		};

		if (regParams.scope == "invoice") {
			this_request["scope"] = "invoice";
			this_request["invoice_id"] = regParams.invoice;
			this_request["checkin_type"] = $('#checkInTypeSelect').children("option:selected").val();
		}
		else {
			this_request["scope"] = "event";
			this_request["event_id"] = regParams.event;
			var thisOccurrence = $("#occurrenceSelect").children("option:selected").val();
			if (thisOccurrence !== "event") {
				this_request["checkin_type"] = "O";
				this_request["occurrence_id"] = thisOccurrence;
			}
		}

		$.each($('.regCheckIn'), function() {
			if ($(this).is(':checked') || $(this).data('existing') == "true") {
				this_request.registrations.push({
					id: $(this).val(),
					cancelled: ($(this).prop('checked') == false),
				});
				$(this).data('existing',"true");
			}
		});
		$.each($('.nameCheckIn'), function() {
			if ($(this).is(':checked') || $(this).data('existing') == "true") {
				this_request.names.push({
					first_name: $(this).data('firstName'),
					last_name: $(this).data('lastName'),
					cancelled: ($(this).prop('checked') == false),
				});
				$(this).data('existing',"true");
			}
		});


	    $.ajax(
	    {
	        url : regParams.ajaxUrl,
	        type: "POST",
            contentType: "application/json",
            data: JSON.stringify(this_request),
			success: function(data, textStatus, jqXHR)
	        {
				if (data["status"] !== "success") {
					$('#update_error').slideDown();
				}
				else {
					$.each($('.regCheckIn'), function() {
						if ($(this).is(':checked') || $(this).data('existing') == "true") {
							$(this).data('existing',"true");
						}
					});
					$.each($('.nameCheckIn'), function() {
						if ($(this).is(':checked') || $(this).data('existing') == "true") {
							$(this).data('existing',"true");
						}
					});
				}
			},
	        error: function(jqXHR, textStatus, errorThrown)
	        {
				console.log(textStatus);
				$('#update_error').slideDown();
	        }
	    });

		setTimeout(function() {
			$(".personCheckIn").removeAttr("disabled");
		}, 500);

	});

	function filterCustomers(table_id, filter) {

		var table = document.getElementById(table_id);
		if (table === null) {
			return;
		}
		var tr = table.getElementsByTagName("tr");

		// Loop through all table rows, and hide those who don't match the search query
		for (i = 0; i < tr.length; i++) {
			td = tr[i].getElementsByClassName("customerInfo")[0];
			if (td) {
			txtValue = td.textContent || td.innerText;
			if (txtValue.toUpperCase().indexOf(filter) > -1) {
				tr[i].style.display = "";
			} else {
				tr[i].style.display = "none";
			}
			}
		}
	}

    // Filter the list of names
    $("#nameFilter").keyup(function() {
		var filter = $(this).val().toUpperCase();
		filterCustomers("regListing", filter);
		filterCustomers("additionalNamesListing", filter);
	});
	
	</script>
{% endaddtoblock %}

{% addtoblock "css" %}
    <style type="text/css">
    .personCheckInLabel {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
        background-color: #6C757D;
        border-radius: 20px;
        transition: all 0.3s;
    }
    .personCheckInLabel::after {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        border-radius:50%;
        background-color: white;
        top: 1px;
        left: 1px;
        transition: all 0.3s;
    }

    .personCheckIn:checked + .personCheckInLabel::after {
        left : 20px;
    }
    .personCheckIn:checked + .personCheckInLabel {
        background-color: #28A745;
    }

    .personCheckIn:disabled + .personCheckInLabel {
        background-color: #BFBFBF;
    }

    .personCheckIn:disabled + .personCheckInLabel::after {
        background-color: #6C757D;
    }

    .personCheckIn {
	    position: absolute;
		opacity: 0;
    }

	.table-fixed thead th {
		position: -webkit-sticky;
		position: sticky;
		top: 44px;
		z-index: 2;
		background-color: #fff;
	}

</style>
{% endaddtoblock %}

{% endblock %}
